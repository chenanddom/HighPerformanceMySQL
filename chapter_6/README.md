# 查询优化

查询优化，索引优化，库表结构优化需要一起考虑才可以。

## 查询速度变慢的原因？

查询可以看作是一个任务,这个任务由一系列的子任务组成,每个子任务都会消耗一定的时间。如果要实现查询的优化就需要优化子任务，
要么消除其中的一些子任务，要么煎炒子任务的执行次数，要么让子任务运行得更加快。


## 慢查询基础:优化数据访问

低效的查询，下面的两个步骤总是很有效：

1. 确认应用程序是否在检索大量超过需要的数据，这些通常意味访问了太多的行，但有时候也可能是访问了太多的列。

2. 确认MySQL服务器层是否在分析大量超过需要的数据行.


### 请求了不需要的数据

查询了多余的数据，增加了MySQL服务器的负担，增加了网络的开销，另外增加对服务器的CPU的消耗和内存资源占用。



### MySQL是否在扫描额外的记录

查看查询是否扫描了过多的数据，对于MySQL,最简单的查询开销的指标如下：

* 响应时间
响应时间分两部分，服务时间和排队时间。服务时间是指数据库处理这个查询的真正的花了多长时间。
排队时间是指服务器因为等待某些资源而没有真正的执行查询的时间-----可能是一些I/O操作完成或者等待锁。





* 扫描的行数
* 返回的数据

分析查询时，查看该查询扫描的行数是很有帮助的。在一定程度上能够说明该查询找到需要的数据的效率不高。

 1. 扫描的行数和访问的类型
 
 在评估查询开销的时候，需要考虑一下从表中找到某一行的数据成本。在EXPLAIN语句中的type列反应了访问的类型。访问类型有很多种，从全表扫描，
 范围扫描，唯一索引查询，常数索引。这些都是的查询的速度都是从慢到快，扫描的行数也是从小到大，
 
  走索引的方式
![扫描的行数和访问的类型](images/scan_rows.png)

  不走索引的方式
![扫描的行数和访问的类型](images/scan_rows_2.png)  
  
通过上面的方式可以知道走索引可以知道扫描的函数会很少，如果不走索引机会全表扫描。


一般MySQL能够使用如下的三种方式应用where条件，从好到坏依次为：
1. * 在索引中使用WHERE条件来过滤不匹配的的记录。这是在存储引擎层完成的。

2. * 使用所有覆盖扫描(在Extra列出现Using index)来返回记录，直接从索引中过滤不需要的记录并返回命中
的结果。这是在MySQL服务器层完成的，但是无需再徽标查询记录。


3. * 从数据表中返回数据，然后过滤不满足条件的记录(再Extra列中出现Using Where)。这在MySQL服务器层完成。
MySQL需要先从数据表读出记录然后过滤。


扫描大量的数据但是只返回少数的行，通常可以尝试下面的技巧优化：

1. 使用索引覆盖扫描，把所有需要的列都放在索引中，这样存储引擎无需徽标获取对应的行就可以返回结果了。

2. 该表表结构，建立单独的汇总表。

3. 重写复杂的查询。


  
  
## 重构查询的方式

### 一个复杂的查询还是多个简单查询

现代的MySQL已经可以实现连接和断开轻量级化，返回以恶搞很小的查询的结构方面都很高效。
现代的网络速度比以前要快很多，多个小查询都不在是大问题。但是如果一个查询可以完成就没
必要拆分多个查询。



### 切分大查询






















     

















































